@page "/FreindFinder"
@using System.Net.Http.Headers;
@using PrideLink.Client.Helpers;
@using PrideLink.Shared.FreindFinderDetails;
@using PrideLink.Shared.Location;
@using PrideLink.Shared.LoginDetails;
@using PrideLink.Client.Shared;
@inject IJSRuntime JSRuntime
@inject HttpClient _Http
@inject jwtHelper _jwt_helper

<style>
    .scrollable-images-container {
        display: flex;
        overflow-x: scroll; /* Enable horizontal scroll */
        gap: 10px; /* Add some space between images */
    }

    .card-image {
        max-height: 200px; /* Adjust the height as needed */
        flex: 0 0 auto; /* Prevent shrinking of images */
        width: auto; /* Ensure proportional width */
        border-radius: 5px;
    }

    .custom-box {
        border: 2px solid #000000; /* Blue border color */
        padding: 15px; /* Padding around the text */
        border-radius: 5px; /* Rounded corners */
        background-color: #f8f9fa; /* Light background color */
    }
</style>
@if (userRejectedLocationCheck)
{
    <div class="container d-flex justify-content-center align-items-center">
        <div class="card border-primary mb-3 " style="max-width: 20rem;">
            <div class="card-header">Location Unavailable</div>
            <div class="card-body">
                <h4 class="card-title">Unable to get User Location:</h4>
                <p class="card-text">As part of this platform a key feature is showing people in your area. As we was unable to verify you location please navigate to Account Settings</p>
                <h4 class="card-title">What can you do to get verified:</h4>
                <p class="card-text">If a freind referred you they can verify who you are. If your new and dont know anyone you can contact me on discord</p>
                <a href="https://discordapp.com/users/maddibailey" target="_blank"
                   class="form-control text-primary">maddibailey</a>
            </div>
        </div>
    </div>
}
@if (showPopup)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title">Verification Request</h5>
                </div>
                <div class="modal-body">
                    <p>Do you want to verify user <strong>@selectedUserName</strong>?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="Deny">Cancel</button>
                    <button class="btn btn-primary" @onclick="Allow">Verify</button>
                </div>
            </div>
        </div>
    </div>
}
else
{
    @if (isLoading)
    {
        <LoadingView Percentage="loadingPercentage" LoadingText="Loading, please wait..." CurrentStepText="@currentStep" />
    }
    else
    {
        if (!userIsVerified)
        {
            <div class="container d-flex justify-content-center align-items-center">
                <div class="card border-primary mb-3 " style="max-width: 20rem;">
                    <div class="card-header">User is unverified</div>
                    <div class="card-body">
                        <h4 class="card-title">Why cant I see other accounts:</h4>
                        <p class="card-text">As part of this platform a key feature is safety.Until you are verified you will be unable to view other accounts.</p>
                        <h4 class="card-title">What can you do to get verified:</h4>
                        <p class="card-text">If a freind referred you they can verify who you are. If your new and dont know anyone you can contact me on discord</p>
                        <a href="https://discordapp.com/users/maddibailey" target="_blank"
                           class="form-control text-primary">maddibailey</a>
                    </div>
                </div>
            </div>
        }
        else
        {
            @foreach (var finderAccount in userFreindFinderAccounts)
            {
                <div class="card mb-4 shadow-sm border-0 rounded-4">
                    <!-- Header -->
                    <div class="card-header bg-light d-flex justify-content-between align-items-center rounded-top-4">
                        <h3 class="mb-0">@finderAccount.UserAccountGeneralInfo.DisplayName</h3>

                        <div class="d-flex align-items-center" style="gap: 10px;">
                            <!-- Verification Badge -->
                            @if (userAllowedToVerify && finderAccount.UserAccountGeneralInfo.UserVerified == "Unverified")
                            {
                                <span class="badge bg-secondary text-dark"
                                      style="cursor: pointer;"
                                      @onclick="() => ShowVerifyPopup(finderAccount.userNo)">
                                    @finderAccount.UserAccountGeneralInfo.UserVerified
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-info text-light">
                                    @finderAccount.UserAccountGeneralInfo.UserVerified
                                </span>
                            }

                            @if (finderAccount.UserAccountGeneralInfo.FriendStatus == "Accepted")
                            {
                                <button class="btn btn-outline-primary btn-sm"
                                        @onclick="() => UnFriend(finderAccount.userNo)">
                                    <i class="bi bi-person-plus"></i> Unfriend
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-outline-primary btn-sm"
                                        @onclick="() => AddFriend(finderAccount.userNo)">
                                    <i class="bi bi-person-plus"></i> Add Friend
                                </button>
                            }
                        </div>
                    </div>
                    

                    <!-- Profile Images -->
                    <div class="scrollable-images-container d-flex flex-row overflow-auto p-2" style="gap: 10px;">
                        @foreach (var base64Image in finderAccount.UserAccountPictures)
                        {
                            if (!string.IsNullOrEmpty(base64Image.base64Image))
                            {
                                <img src="@base64Image.base64Image"
                                     class="rounded-3"
                                     style="object-fit: cover; width: 180px; height: 180px;"
                                     alt="User image" />
                            }
                        }
                    </div>
                    <div class="card-body">
                        <h5 class="card-title  mb-4">Age: @finderAccount.UserAccountGeneralInfo.Age</h5>

                    <!-- About Me -->

                        <h4 class="fw-semibold">About me</h4>
                        <div class="p-3 border rounded-3 bg-light">
                            <p class="mb-0">@finderAccount.UserAccountGeneralInfo.BioDescription</p>
                        </div>
                    </div>
                    <!-- Test -->
                    @* <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#Hobbies" aria-selected="false" role="tab" tabindex="-1">Hobbies</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" data-bs-toggle="tab" href="#Socials" aria-selected="true" role="tab">Socials</a>
                        </li>
                    </ul>
                    <div id="myTabContent" class="tab-content">
                        <div class="tab-pane fade" id="Hobbies" role="tabpanel">
                            <div class="card-body">
                                <h4 class="card-title">Light card title</h4>
                                @foreach (var hobby in finderAccount.UserAccountHobbies)
                                {
                                    <button class="btn btn-primary rounded-pill me-2 mt-2" disabled>
                                        @hobby.HobbyName
                                    </button>
                                }
                            </div>
                        </div>
                        <div class="tab-pane fade active show" id="Socials" role="tabpanel">
                            <div class="card-body">
                                <h4 class="card-title">Light card title</h4>
                                @{
                                    var socials = new Dictionary<string, (string Url, string? Value)>
                                    {
                                        ["Instagram"] = ("https://instagram.com/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 1)?.socialValue),
                                        ["Snapchat"] = ("https://snapchat.com/add/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 2)?.socialValue),
                                        ["WhatsApp"] = ("https://wa.me/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 3)?.socialValue),
                                        ["Discord"] = ("https://discordapp.com/users/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 4)?.socialValue)
                                    };
                                }

                                @foreach (var social in socials)
                                {
                                    <label class="form-label mt-3">@social.Key</label>

                                    @if (!string.IsNullOrWhiteSpace(social.Value.Value))
                                    {
                                        <a href="@($"{social.Value.Url}{social.Value.Value}")"
                                           target="_blank"
                                           class="form-control text-primary">
                                            @social.Value.Value
                                        </a>
                                    }
                                    else
                                    {
                                        <p class="form-text text-muted">No @social.Key linked</p>
                                    }
                                }
                            </div>
                        </div>
                    </div> *@
                    <!-- Accordion -->
                    <div class="accordion" id="accordion_@finderAccount.userNo">
                        <!-- Hobbies -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingHobbies_@finderAccount.userNo">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseHobbies_@finderAccount.userNo"
                                        aria-expanded="false"
                                        aria-controls="collapseHobbies_@finderAccount.userNo">
                                    Hobbies
                                </button>
                            </h2>
                            <div id="collapseHobbies_@finderAccount.userNo"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="headingHobbies_@finderAccount.userNo"
                                 data-bs-parent="#accordion_@finderAccount.userNo">
                                <div class="accordion-body">
                                    @foreach (var hobby in finderAccount.UserAccountHobbies)
                                    {
                                        <button class="btn btn-primary rounded-pill me-2 mt-2" disabled>
                                            @hobby.HobbyName
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Socials -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSocials_@finderAccount.userNo">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseSocials_@finderAccount.userNo"
                                        aria-expanded="false"
                                        aria-controls="collapseSocials_@finderAccount.userNo">
                                    Socials
                                </button>
                            </h2>
                            <div id="collapseSocials_@finderAccount.userNo"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="headingSocials_@finderAccount.userNo"
                                 data-bs-parent="#accordion_@finderAccount.userNo">
                                <div class="accordion-body">
                                    @{
                                        var socials = new Dictionary<string, (string Url, string? Value)>
                                        {
                                            ["Instagram"] = ("https://instagram.com/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 1)?.socialValue),
                                            ["Snapchat"] = ("https://snapchat.com/add/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 2)?.socialValue),
                                            ["WhatsApp"] = ("https://wa.me/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 3)?.socialValue),
                                            ["Discord"] = ("https://discordapp.com/users/", finderAccount.UserAccountSocials.FirstOrDefault(e => e.socialTypeNo == 4)?.socialValue)
                                        };
                                    }

                                    @foreach (var social in socials)
                                    {
                                        <label class="form-label mt-3">@social.Key</label>

                                        @if (!string.IsNullOrWhiteSpace(social.Value.Value))
                                        {
                                            <a href="@($"{social.Value.Url}{social.Value.Value}")"
                                               target="_blank"
                                               class="form-control text-primary">
                                                @social.Value.Value
                                            </a>
                                        }
                                        else
                                        {
                                            <p class="form-text text-muted">No @social.Key linked</p>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    }
}




@code {
    private bool isLoading = true;
    private double loadingPercentage = 0;
    private string currentStep = "...";

    private bool userIsVerified = false;
    private bool userAllowedToVerify = false;

    private bool userRejectedLocationCheck = false;

    private int selectedUserNo;
    private string selectedUserName;
    private bool showPopup;

    // private string cardHeader;
    // private string cardTitle;
    // private string cardSubtitle;
    private List<string> base64Images;
    private string cardContent;
    private List<string> listGroupItems;
    private string cardFooter;

    private double latitude;
    private double longitude;
    private bool locationReceived = false;
    private jwtToken? token;
    private UserLocationData userLocationData = new UserLocationData();
    private List<UserFreindFinderAccount> userFreindFinderAccounts = new List<UserFreindFinderAccount>();

    private async Task AddFriend(int userNo)
    {
        Console.WriteLine("Adding friend with userNo: " + userNo);
        var response = await _Http.PostAsync("/api/Friend/AddFriend?friendUserNo=" + userNo,null);
    }

    private async Task UnFriend(int userNo)
    {
        Console.WriteLine("Unfriend: " + userNo);
        // var response = await _Http.PatchAsync("/api/Friend/AcceptFriendRequest?friendUserNo=" + userNo, null);
    }

    private async Task ShowVerifyPopup(int userNo)
    {
        selectedUserNo = userNo;
        selectedUserName = userFreindFinderAccounts.FirstOrDefault(e => e.userNo == userNo).UserAccountGeneralInfo.DisplayName;
        showPopup = true;
    }

    private async Task Deny()
    {
        showPopup = false;
    }

    private async Task Allow()
    {
        showPopup = false;
        var response = await _Http.PatchAsync("/api/General/UpdateVerificationStatus/?userNo=" + selectedUserNo + "&userTypeName=Verified", null);
        if (response.IsSuccessStatusCode)
        {

            userFreindFinderAccounts.FirstOrDefault(e => e.userNo == selectedUserNo).UserAccountGeneralInfo.UserVerified = "Verified";
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Log component start
        await JSRuntime.InvokeVoidAsync("console.log", "FreindFinder.OnInitializedAsync starting");

        // Initialize collections
        userFreindFinderAccounts = new List<UserFreindFinderAccount>();
        base64Images = new List<string>(); //TODO change to get pics
        listGroupItems = new List<string>(); //TODO probably change with hobbys

        userIsVerified = (await IsUserVerified());
        if (userIsVerified)
        {
            await UserAllowedToVerify();

            loadingPercentage += 25;
            currentStep = "Getting Location";
            StateHasChanged();

            // Step 1: Get location
            await GetLocation();
            loadingPercentage += 25;
            currentStep = "Updating Location";
            StateHasChanged();

            // Step 2: Upload user location (guarded)
            await UploadUserLocation();
            loadingPercentage += 25;
            currentStep = "Finding you your next freind";
            StateHasChanged();

            // Step 3: Get user account info (guarded)
            await GetAllUserAccountInfo();
            loadingPercentage += 25;
            StateHasChanged();

            isLoading = false;
            StateHasChanged();
        }
        else
        {
            isLoading = false;
        }

    }

    private async Task UserAllowedToVerify()
    {
        var response = await _Http.GetAsync("api/Login/IsUserInRole/?roleName=Verifier");
        switch (response.StatusCode)
        {
            case System.Net.HttpStatusCode.OK:
                userAllowedToVerify = true;
                break;
            case System.Net.HttpStatusCode.Forbidden:
                userAllowedToVerify = false;
                break;
            default:
                userAllowedToVerify = false;
                break;
        };
        ;
    }

    private async Task<bool> IsUserVerified()
    {
        var response = await _Http.GetAsync("api/General/UserVerificationStatus");
        string userStatus = await response.Content.ReadAsStringAsync();
        switch (userStatus)
        {
            case "Verified":
                return true;
            case "Unverified":
                return false;
            default:
                return false;
        };
    }

    private async Task GetLocation()
    {
        try
        {
            var location = await JSRuntime.InvokeAsync<Dictionary<string, double>>("getLocation");
            userLocationData.Latitude = (float)location["latitude"];
            userLocationData.Longitude = (float)location["longitude"];
            locationReceived = true;

            latitude = userLocationData.Latitude;
            longitude = userLocationData.Longitude;

            Console.WriteLine($"Received Location: Latitude = {latitude}, Longitude = {longitude}");
        }
        catch (Exception ex)
        {
            var response = await _Http.GetAsync("api/UserLocation/GetLocationFromCityAndTown");
            if (response.IsSuccessStatusCode)
            {
                userLocationData = await response.Content.ReadFromJsonAsync<UserLocationData>();
            }
            StateHasChanged();
            Console.WriteLine($"Error retrieving location: {ex.Message}");
        }
    }

    private async Task UploadUserLocation()
    {
        var response = await _Http.PostAsJsonAsync<UserLocationData>("api/UserLocation/AddUpdateUserLocation", userLocationData);
        Console.WriteLine($"UploadUserLocation response: {response.StatusCode}");
    }

    private async Task GetAllUserAccountInfo()
    {
        var response = await _Http.PostAsJsonAsync<UserLocationData>("api/FreindFinderAccountInfo/GetFreindFinderAccountInfo", userLocationData);
        Console.WriteLine($"GetAllUserAccountInfo response: {response.StatusCode}");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadFromJsonAsync<List<UserFreindFinderAccount>>();
            userFreindFinderAccounts = content ?? new List<UserFreindFinderAccount>();
            Console.WriteLine($"Fetched {userFreindFinderAccounts.Count} accounts");
        }
    }
}
