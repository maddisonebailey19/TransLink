@page "/login"
@using PrideLink.Client.Helpers
@using PrideLink.Shared.LoginDetails
@using System.Text.Json
@using System.Net
@using System.Net.Http.Headers
@using PrideLink.Shared.Notification

@inject LoginStatus _loginStatus;
@inject IJSRuntime _JS
@inject HttpClient _Http
@inject NavigationManager _Navigation
@inject NotificationService _notificationService

<h3>Login</h3>
<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card border-primary mb-3" style="max-width: 30rem;">
        @if (!createLogin)
        {
        <div class="card-header">Login</div>
            <div class="card-body">
                @if (invalidUserName != null)
                {
                    <p class="text-danger">@invalidUserName</p>
                }
                <label for="userName">Email:</label>
                <input type="email" id="userName" class="form-control" @bind="loginDetails.userName" />
                <p></p>
                <label for="password">Enter Password:</label>
                <input type="password" id="password" class="form-control" @bind="loginDetails.password" />
                <p></p>

                <button type="button" class="btn btn-primary" style="width: 120px; margin-right: 10px;" @onclick="CheckLogin">Login</button>
                <button type="button" class="btn btn-primary" style="width: 120px" @onclick="CreateLogin">Create User</button>
            </div>
        }
        else
        {
            <div class="card-header">Create Login</div>
            <div class="card-body">
                @if (invalidUserName != null)
                {
                    <p class="text-danger">@invalidUserName</p>
                }
                <label for="userName">Email:</label>
                <input type="email" id="userName" class="form-control" @bind="loginDetails.userName" />
                <p></p>
                <label for="password">Enter Password:</label>
                <input type="password" id="password" class="form-control" @bind="loginDetails.password" />
                <p></p>
                @if (!verifyEmailSent)
                {
                    <div class="d-flex justify-content-center">
                        <button type="button" class="btn btn-primary" style="width: 120px" @onclick="SetupUser">
                            Create User
                        </button>
                    </div>
                }
                else
                {
                    <div class="text-center">
                        <label for="verificationNo" class="form-label fw-semibold">Enter Verification Code:</label>
                        <input type="text"
                               id="verificationNo"
                               class="form-control text-center mx-auto"
                               style="max-width: 200px; font-size: 1.2rem; letter-spacing: 3px;"
                               @bind="verificationCode" />

                        <div class="d-flex justify-content-center mt-3">
                            <button type="button"
                                    class="btn btn-primary px-4"
                                    style="border-radius: 6px;"
                                    @onclick="NewUserLogin">
                                Login
                            </button>
                        </div>
                    </div>
                }
                

                
            </div>
        }
        @* <div class="d-flex justify-content-center">
            <button type="button" class="btn btn-primary" style="width: 120px" @onclick="TestEmail">
                Test Email
            </button>
        </div> *@
    </div>
</div>
@code {
    private bool attemptedLogin = false;
    private bool createLogin = false;
    private bool verifyEmailSent = false;
    private bool loginCreated = false;
    private bool usernameInvalid = false;
    private string? invalidUserName = null;
    private int? verificationCode = null;
    LoginDetail loginDetails = new LoginDetail();

    // private async void TestEmail()
    // {
    //     NotificationContent notificationContent = new NotificationContent();
    //     notificationContent.ToEmail = "ethanbailey65@gmail.com";
    //     notificationContent.Subject = "🌈 Welcome to TransLink!";
    //     notificationContent.EmailContentNo = 1;
    //     notificationContent.EmailContents = new Dictionary<string, string>
    //     {
    //         { "@userName", "Ethan" }
    //     };

    //     //string emailContentJson = JsonSerializer.Serialize(notificationContent);
    //     var emailResponse = await _Http.PostAsJsonAsync("api/Notifications/SendEmail", notificationContent);
    // }
    private async void NewUserLogin()
    {
        string URL = "?userName=" + loginDetails.userName.Split("@")[0] + "&verificationCode=" + verificationCode;
        var verificationCodeResponse = await _Http.GetAsync("api/Login/CheckVerificationCode" + URL);
        if (verificationCodeResponse.IsSuccessStatusCode)
        {
            _Navigation.NavigateTo("/TermsAndConditions");
        }
        StateHasChanged();
    }
    private async void CheckLogin()
    { 
        invalidUserName = null;
        if (loginDetails.userName.Contains("@") && loginDetails.userName.Contains("."))
        {
            string urlString = "?userName=" + loginDetails.userName + "&password=" + loginDetails.password;
            var response = await _Http.GetAsync("api/Login/Login-Checker" + urlString);
            if (response.IsSuccessStatusCode)
            {
                // jwtToken result = await response.Content.ReadFromJsonAsync<jwtToken>();
                // _JS.InvokeVoidAsync("localStorage.setItem", "Token", JsonSerializer.Serialize(result));

                var userNoResponse = await _Http.GetAsync("api/Login/GetUserID");

                if (userNoResponse.IsSuccessStatusCode)
                {
                    string userNo = await userNoResponse.Content.ReadAsStringAsync();
                    _loginStatus.userNo = userNo;
                    _loginStatus.NotifyStateChanged();
                    await _notificationService.InitializeAsync(userNo, _Navigation);
                }

                _Navigation.NavigateTo("/");


            }
            else
            {
                attemptedLogin = true;
                invalidUserName = "Email or password is incorrect";
                StateHasChanged();
            }
        }
        else
        {
            invalidUserName = "Invalid email";
            StateHasChanged();
        }

    }

    // Changed to return Task so errors can be observed and UI updated reliably
    private async Task SetupUser()
    {
        string URL = "?userName=" + loginDetails.userName + "&password=" + loginDetails.password;
        var response = await _Http.GetAsync("api/Login/Login-Creator" + URL);

        if (response.IsSuccessStatusCode)
        {
            NotificationContent notificationContent = new NotificationContent();
            notificationContent.ToEmail = loginDetails.userName;
            notificationContent.Subject = "🌈 Welcome to TransLink!";
            notificationContent.EmailContentNo = 2;
            notificationContent.EmailContents = new Dictionary<string, string>
            {
                { "@userName", loginDetails.userName.Split("@")[0] }
            };

            var emailResponse = await _Http.PostAsJsonAsync("api/Notifications/VerificationSendEmail", notificationContent);
            if(emailResponse.IsSuccessStatusCode)
            {
                verifyEmailSent = true;
            }

            UserCreated result = await response.Content.ReadFromJsonAsync<UserCreated>();
            if (result.userNo == -1)
            {
                invalidUserName = "Username already taken";
            }
            else
            {

                // attemptedLogin = false;
                // createLogin = false;
                // loginCreated = true;
            }

            StateHasChanged();
            return;
        }

        // Handle known server responses (422 used by API when username exists)
        if (response.StatusCode == HttpStatusCode.UnprocessableEntity)
        {
            invalidUserName = "Email already taken";
        }
        else if (response.StatusCode == HttpStatusCode.Conflict)
        {
            // alternative common status code for duplicates
            invalidUserName = "Email already taken";
        }
        else
        {
            // Generic error fallback - show message to user
            invalidUserName = $"Unable to create account ({(int)response.StatusCode} {response.ReasonPhrase})";
        }

        StateHasChanged();
    }

    private async void ReTry()
    {
        attemptedLogin = false;
        StateHasChanged();
    }

    private async void CreateLogin()
    {
        invalidUserName = null;
        attemptedLogin = false;
        createLogin = true;
        StateHasChanged();
    }
}